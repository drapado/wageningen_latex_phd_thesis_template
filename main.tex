%==============================================================================
% TEMPLATE FOR THESIS WAGENINGEN UNIVERSITY
% CREATED BY AREND LIGTENBERG JUNE 2006;
% EDITED BY KIM CALDERS 2014;
% EDITED BY BEN DEVRIES 2015;
% EDITED BY LOIC DUTRIEUX 2016
%==============================================================================

\documentclass[10pt,twoside]{book}
\usepackage[T1]{fontenc}
% \usepackage{lmodern}
\usepackage[utf8]{inputenc}
\usepackage[dutch,english]{babel}
\usepackage{graphicx}
\usepackage{natbib}
\usepackage{bibentry} % bibentry for inserting complete BibTeX entries inline, explanation: http://stefaanlippens.net/bibentry
\nobibliography* % required by bibentry package;
\usepackage{amsmath}
\usepackage{fancyhdr}
\usepackage[small,bf]{caption}
%\captionsetup[table]{skip=10pt}
\usepackage{multirow}
\usepackage{threeparttable}
%\usepackage[body={6.0in, 8.2in},left=1.50in,right=1.50in]{geometry} %% very narrow
\usepackage[paperwidth=170mm, paperheight=240mm, margin=20mm]{geometry}
\usepackage[parfill]{parskip}
\usepackage{enumitem}
%\usepackage[rightcaption]{sidecap}
%\usepackage{epstopdf}
\usepackage{pdfpages}
\usepackage[hidelinks]{hyperref}
\usepackage{color}
\usepackage{xcolor}
\usepackage{colortbl}
\usepackage{appendix}

% extra packages added by Ben
\usepackage{rotating} % for rotating figures
\usepackage{changepage} % for indenting entire paragraphs
\usepackage{float} % help with table positioning
\floatstyle{plaintop} % caption on top
\restylefloat{table} % see above. Use: \begin{table}[H]
\usepackage{textcomp} % \textdegree
% \usepackage{fixltx2e} % for the \textsubscript command outside of a math environment. Removed by david, not required after 2015
\usepackage{csquotes} % for block quotes, use {displayquote} environment
\usepackage{todonotes}
\usepackage{soul}
\usepackage{fp}
\usepackage{tabularx}
\usepackage{subcaption}
\usepackage{pdflscape}
\usepackage{gensymb}
\usepackage[version=4]{mhchem}
\usepackage{wrapfig}

% Extra packages added by David
\usepackage{nomencl}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\usepackage{amssymb}
\usepackage{booktabs}
\usepackage{doi}
\usepackage{tikz} % for thumb tabs
\usepackage{lipsum} % for lorem ipsum text

\addto\captionsenglish{\renewcommand{\bibname}{References}}

\definecolor{Red}{rgb}{0.5,0,0}
\definecolor{Blue}{rgb}{0,0,0.5}


%=======================================================================
% GENERAL SETTINGS
%=======================================================================
%\oddsidemargin 40pt
%\evensidemargin 40pt
\setlength{\captionmargin}{5pt}
%\setlength{\textfloatsep}{10pt plus 1.0pt minus 2.0pt}
%\usepackage{pifont}
%\usepackage{times}
%\usepackage{txfonts}
\usepackage[sc]{mathpazo}
%\usepackage{setspace}

\linespread{1.1} %1 is single spacing, 1.3 is oneandhalf spacing


%\citationstyle{dcu}
\sloppy
\setcounter{tocdepth}{0}

%% for internal use
\newcommand{\fixme}[1]{\emph{\marginpar{FIXME} (#1)}}
\newcommand{\readme}[1]{\emph{\marginpar{README} (#1)}}
\newcommand{\verifyme}[1]{\emph{\marginpar{VERIFYME} (#1)}}


%=======================================================================
% THUMB TABS FOR CHAPTERS
%=======================================================================
% Chapter counter for thumb tab positioning
\newcounter{thumbchapter}
\setcounter{thumbchapter}{0}

% DEFINITION OF THE FANCY HEADERS
%=======================================================================
\pagestyle{fancy}
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection\ #1}}
\fancyhf{}
\fancyhead[LE,RO]{\bfseries\thepage}
\fancyhead[LO]{\bfseries\rightmark}
\fancyhead[RE]{\bfseries\leftmark}

% Add thumb tabs to headers
\fancyhead[RO]{%
  \bfseries\thepage%
  \ifnum\value{chapter}>0%
    \begin{tikzpicture}[remember picture, overlay]
      \node[
        fill=gray!80,
        text=white,
        font=\bfseries\normalsize,
        minimum height=1.0cm,
        minimum width=0.8cm,
        anchor=north east,
        rotate=0
      ] at ([xshift=0mm, yshift=-\value{thumbchapter}*1.8cm-2cm]current page.north east) {\thechapter};
    \end{tikzpicture}%
  \fi%
}
\fancyhead[LE]{%
  \bfseries\thepage%
  \ifnum\value{chapter}>0%
    \begin{tikzpicture}[remember picture, overlay]
      \node[
        fill=gray!80,
        text=white,
        font=\bfseries\normalsize,
        minimum height=1.0cm,
        minimum width=0.8cm,
        anchor=north west,
        rotate=0
      ] at ([xshift=0mm, yshift=-\value{thumbchapter}*1.8cm-2cm]current page.north west) {\thechapter};
    \end{tikzpicture}%
  \fi%
}

%=======================================================================
% NEW ENVIRONMENT FOR THE START OF CHAPTER (SMALL ABSTRACT)
%=======================================================================
\newenvironment{chapintro}
{
    \begin{center}
    \begin{minipage}[t]{0.9\textwidth}
    \hrule
    \medskip
    \small
}
{
    \medskip
    \hrule
    \end{minipage}
    \end{center}
    \bigskip
}


%=======================================================================
% ADD WORD CHAPTER FOR TOC
%=======================================================================


\makeatletter
\let\orig@chapter\@chapter
\def\@chapter[#1]#2{\ifnum \c@secnumdepth >\m@ne
                       \if@mainmatter
                         \refstepcounter{chapter}%
                         \typeout{\@chapapp\space\thechapter.}%
                         \addcontentsline{toc}{chapter}%
                                   {Chapter~\protect\numberline{\thechapter}#1}%
                       \else
                         \addcontentsline{toc}{chapter}{#1}%
                       \fi
                    \else
                      \addcontentsline{toc}{chapter}{#1}%
                    \fi
                    \chaptermark{#1}%
                    \addtocontents{lof}{\protect\addvspace{10\p@}}%
                    \addtocontents{lot}{\protect\addvspace{10\p@}}%
                    \if@twocolumn
                      \@topnewpage[\@makechapterhead{#2}]%
                    \else
                      \@makechapterhead{#2}%
                      \@afterheading
                    \fi}
\makeatother

%=======================================================================
% CUSTOM CHAPTER HEAD FORMATTING - REDUCE TOP SPACING
%=======================================================================
\makeatletter
\def\@makechapterhead#1{%
  \vspace*{15\p@}%  % Negative spacing to move chapter titles up by ~1.5cm
  {\parindent \z@ \raggedright \normalfont
    \ifnum \c@secnumdepth >\m@ne
      \if@mainmatter
        \huge\bfseries \@chapapp\space \thechapter
        \par\nobreak
        \vskip 20\p@
      \fi
    \fi
    \interlinepenalty\@M
    \Huge \bfseries #1\par\nobreak
    \vskip 40\p@
  }}
\makeatother

%=======================================================================
% CUSTOM UNNUMBERED CHAPTER HEAD FORMATTING (for Contents, etc.)
%=======================================================================
\makeatletter
\def\@makeschapterhead#1{%
  \vspace*{-15\p@}%  % Same negative spacing for unnumbered chapters
  {\parindent \z@ \raggedright
    \normalfont
    \interlinepenalty\@M
    \Huge \bfseries #1\par\nobreak
    \vskip 40\p@
  }}
\makeatother

%=======================================================================
% A BIT MORE COMPACT ITEM LIST
%=======================================================================
\newenvironment{itemize*}%
  {\begin{itemize}%
    \setlength{\parskip}{0pt}%
    \setlength{\itemsep}{0pt}%
    \setlength{\parsep}{0pt}}%
  {\end{itemize}}

%more compact enumeration list
  \newenvironment{enumerate*}%
  {\begin{enumerate}%
    \setlength{\itemsep}{0pt}%
    \setlength{\parskip}{0pt}}%
  {\end{enumerate}}

%=======================================================================
% A BIT MORE COMPACT DESCRIPTION LIST
%=======================================================================
\renewcommand{\descriptionlabel}[1]{\hspace{\labelsep}\textrm{#1}}

\newenvironment{description*}%
  {\begin{description}%
    \setlength{\itemsep}{0pt}%
    \setlength{\parskip}{0pt}}%
  {\end{description}}

%=======================================================================
% A BIT MORE COMPACT BIBLIOGRAPHY
%=======================================================================
  \let\oldthebibliography=\thebibliography
  \let\endoldthebibliography=\endthebibliography
  \renewenvironment{thebibliography}[1]{%
    \begin{oldthebibliography}{#1}%
      \setlength{\parskip}{0ex}%
      \setlength{\itemsep}{1ex}%
  }%
  {%
    \end{oldthebibliography}%
  }

%=======================================================================
% CLEAR HEADER STYLE ON LAST EMPTY ODD PAGES
%=======================================================================
\makeatletter
\def\cleardoublepage{\clearpage\if@twoside \ifodd\c@page\else%
\hbox{}%
\thispagestyle{empty}%
\newpage%
\if@twocolumn\hbox{}\newpage\fi\fi\fi}
\makeatother


%=======================================================================
% SOME EXTRA COMMANDS FOR VISUAL LAYOUT
%=======================================================================
\newcommand{\longpage}{\enlargethispage{\baselineskip}}
\newcommand{\shortpage}{\enlargethispage{-\baselineskip}}
\newcommand{\setreference}{\vspace*{\fill}}

%=======================================================================
% LIST ENVIRONMENT FOR OWN SELECTED PUBLICATIONS
%=======================================================================
\newenvironment{pubs}
{
\begin{list}{}
{%
\item[]}%
\setlength{\itemindent}{-25pt}%
\setlength{\parsep}{-0pt}
\setlength{\itemsep}{-0pt}
}%
{\end{list}%
}%


%==============================
% REFORMAT SECTION HEADINGS
%==============================

%% using titlesec
\usepackage{titlesec}
%% FIX FOR BUG in titlesec 2.10.1
\usepackage{etoolbox}

\makeatletter
\patchcmd{\ttlh@hang}{\parindent\z@}{\parindent\z@\leavevmode}{}{}
\patchcmd{\ttlh@hang}{\noindent}{}{}{}
\makeatother
%% END OF BUGFIX

\titleformat{\subsection}
  {\normalfont\normalsize\bfseries}
  {\thesubsection}{1em}{}
\titleformat{\subsubsection}
  {\normalfont\normalsize\itshape}
  {\thesubsubsection}{1em}{}



%==============================
% Force start of newpage on left page
%==============================
\newcommand*\cleartoleftpage{%
  \clearpage
  \ifodd\value{page}\hbox{}\newpage\fi
}



%=======================================================================
% INCLUSION OF THE CONTENT
%=======================================================================

\raggedbottom % preferentially leaves whitespace at bottom of page instead of distributing throughout vertical space

\begin{document}

\frontmatter
\pagenumbering{alph}
\pagenumbering{roman}
\addtocontents{toc}{~\hfill\rlap{\textbf{Page}}\par}
\include{000_Title}
\cleardoublepage
\cleardoublepage
\phantomsection

\include{002_Summary}
\cleardoublepage
\phantomsection

\addcontentsline{toc}{chapter}{Contents}  
\tableofcontents
\cleardoublepage
\phantomsection
\pagenumbering{arabic} \setcounter{page}{1}


%% Main Chapters
\mainmatter
\setcounter{page}{1}
\setcounter{thumbchapter}{1}\include{01_chapter1} % Introduction 
\stepcounter{thumbchapter}\include{02_chapter2}
\stepcounter{thumbchapter}\include{03_chapter3}
\stepcounter{thumbchapter}\include{04_chapter4}
\stepcounter{thumbchapter}\include{05_chapter5}
\stepcounter{thumbchapter}\include{06_chapter6} % Discussion


\backmatter
\bibliographystyle{model5-names}
\phantomsection
\addcontentsline{toc}{chapter}{References}
\bibliography{references}
\fancyhead{}

\cleardoublepage
\phantomsection

\addcontentsline{toc}{chapter}{Acknowledgements}
\include{001_Acknowledgements}
\cleardoublepage
\phantomsection

%% Back Matter
\phantomsection
\include{07_biography}
\cleardoublepage
\phantomsection

\include{08_TESF}

\renewcommand{\headrulewidth}{0pt}
\cleartoleftpage

\include{09_authorship}
\cleartoleftpage

\include{10_funding}
\end{document}